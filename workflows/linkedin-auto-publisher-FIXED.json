{
  "name": "Green Hub Portal - LinkedIn Auto-Publisher (Corregido)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 3
            }
          ]
        }
      },
      "id": "4563f5a4-033a-4588-9f51-19cc7a06dd92",
      "name": "â° Ejecutar cada 3 horas",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [-1280, 0]
    },
    {
      "parameters": {
        "url": "https://techcrunch.com/feed/",
        "options": {}
      },
      "id": "f540a2b8-9636-4446-a7ca-35e0a5fb9ef6",
      "name": "ğŸ“° RSS TechCrunch",
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.2,
      "position": [-1056, -96]
    },
    {
      "parameters": {
        "url": "https://news.ycombinator.com/rss",
        "options": {}
      },
      "id": "0deb6ea9-f390-42f5-926e-c7bb26242deb",
      "name": "ğŸ“° RSS Hacker News",
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.2,
      "position": [-1056, 96]
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "linkedInOAuth2Api",
        "requestMethod": "GET",
        "url": "https://api.linkedin.com/v2/ugcPosts?q=authors&authors=List(urn:li:organization:92768394)&count=10&sortBy=LAST_MODIFIED",
        "options": {
          "timeout": 30000
        }
      },
      "id": "a8822bc8-c7ea-4bf7-aa71-3cd2b0de9dee",
      "name": "ğŸ“° LinkedIn API (CORREGIDO)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [-1056, 256],
      "credentials": {
        "linkedInOAuth2Api": {
          "id": "iiEjaKHlMEC73APq",
          "name": "LinkedIn account"
        }
      },
      "notes": "âœ… CORREGIDO: Ahora usa endpoint correcto de LinkedIn API v2"
    },
    {
      "parameters": {
        "jsCode": "// Transformar respuesta de LinkedIn API a formato estÃ¡ndar\nconst response = $input.first().json;\nconst posts = [];\n\n// LinkedIn API v2 structure\nif (response.elements) {\n  response.elements.forEach(element => {\n    const text = element.specificContent?.['com.linkedin.ugc.ShareContent']?.shareCommentary?.text || '';\n    const shareUrl = element.specificContent?.['com.linkedin.ugc.ShareContent']?.shareMediaCategory;\n    \n    posts.push({\n      title: text.substring(0, 100) || 'LinkedIn Post',\n      description: text,\n      link: `https://www.linkedin.com/feed/update/${element.id}`,\n      url: `https://www.linkedin.com/feed/update/${element.id}`,\n      pubDate: new Date(element.created?.time || Date.now()).toISOString(),\n      date: new Date(element.created?.time || Date.now()).toISOString(),\n      source: 'LinkedIn',\n      category: 'LinkedIn'\n    });\n  });\n}\n\nreturn posts.map(p => ({ json: p }));"
      },
      "id": "transform-linkedin",
      "name": "ğŸ”„ Transformar LinkedIn",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-848, 256],
      "notes": "âœ… NUEVO: Convierte respuesta de LinkedIn API a formato estÃ¡ndar"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "id": "330b7463-e3a4-426e-b886-c12e15d3a045",
      "name": "ğŸ”„ Combinar Feeds",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [-640, 0]
    },
    {
      "parameters": {
        "jsCode": "// ğŸ¯ Filtrado inteligente sin IA\nconst items = $input.all();\nconst processedItems = [];\nconst seenUrls = new Set();\nconst seenTitles = new Set();\n\nconst HOURS_THRESHOLD = 24;\nconst MAX_POSTS = 5;\nconst cutoffTime = new Date(Date.now() - HOURS_THRESHOLD * 60 * 60 * 1000);\n\nconst KEYWORDS = [\n  'ai', 'inteligencia artificial', 'machine learning',\n  'startup', 'innovaciÃ³n', 'tecnologÃ­a', 'sostenible',\n  'green tech', 'automatizaciÃ³n', 'digital'\n];\n\nitems.forEach(item => {\n  const post = item.json;\n  \n  const url = post.link || post.url || '';\n  const title = post.title || '';\n  const description = post.description || post.summary || '';\n  const pubDate = new Date(post.pubDate || post.date || post.published || Date.now());\n  \n  if (seenUrls.has(url) || seenTitles.has(title.toLowerCase())) return;\n  if (pubDate < cutoffTime) return;\n  \n  let relevanceScore = 0;\n  const content = `${title} ${description}`.toLowerCase();\n  \n  KEYWORDS.forEach(keyword => {\n    if (content.includes(keyword)) relevanceScore += 10;\n  });\n  \n  const hoursOld = (Date.now() - pubDate) / (1000 * 60 * 60);\n  if (hoursOld < 2) relevanceScore += 30;\n  else if (hoursOld < 6) relevanceScore += 20;\n  else if (hoursOld < 12) relevanceScore += 10;\n  \n  const cleanDescription = description\n    .replace(/<[^>]*>/g, '')\n    .replace(/\\s+/g, ' ')\n    .substring(0, 200)\n    .trim();\n  \n  if (relevanceScore > 0 || post.source === 'LinkedIn') {\n    seenUrls.add(url);\n    seenTitles.add(title.toLowerCase());\n    \n    let hostname = '';\n    if (post.source) {\n      hostname = post.source;\n    } else if (url) {\n      const match = url.match(/^https?:\\/\\/([^/]+)/i);\n      hostname = match ? match[1] : '';\n    }\n  \n    processedItems.push({\n      title,\n      url,\n      description: cleanDescription,\n      pubDate: pubDate.toISOString(),\n      relevanceScore,\n      source: hostname,\n      category: post.category || 'TecnologÃ­a'\n    });\n  }\n});\n\nprocessedItems.sort((a, b) => b.relevanceScore - a.relevanceScore);\nconst topPosts = processedItems.slice(0, MAX_POSTS);\n\nconsole.log(`Procesados: ${items.length} | Relevantes: ${processedItems.length} | Top: ${topPosts.length}`);\n\nreturn topPosts.map(p => ({ json: p }));"
      },
      "id": "7bde7063-1ebb-4a6e-a48a-dbb596f8e0aa",
      "name": "ğŸ”§ Filtrar y Puntuar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-432, 0]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/19jRpln8DJaHtalKrKwUZoktJk0mAxrM-ye6dgRhV7dI/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": "Historial",
          "mode": "name"
        },
        "options": {}
      },
      "id": "c1364b83-b806-4138-8c77-cdf3972d024e",
      "name": "ğŸ“Š Leer Historial",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [-224, 0],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Uju33mfMH1AoSojL",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// âœ… CORREGIDO: VerificaciÃ³n de duplicados que SÃ funciona\nconst newPosts = $input.first().json;\nconst historial = $('Leer Historial').all();\n\n// Extraer URLs ya publicadas\nconst publishedUrls = new Set();\nhistorial.forEach(row => {\n  const url = row.json.url || row.json.postId || '';\n  if (url) publishedUrls.add(url);\n});\n\n// Filtrar solo posts nuevos\nconst filteredPosts = $('Filtrar y Puntuar').all().filter(item => {\n  const url = item.json.url;\n  return url && !publishedUrls.has(url);\n});\n\nconsole.log(`Historial: ${publishedUrls.size} posts | Nuevos: ${filteredPosts.length}`);\n\nif (filteredPosts.length === 0) {\n  console.log('âš ï¸ No hay posts nuevos para publicar');\n  return [];\n}\n\nreturn filteredPosts;"
      },
      "id": "check-duplicates",
      "name": "ğŸ” Verificar Duplicados (CORREGIDO)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-16, 0],
      "notes": "âœ… CORREGIDO: Ahora SÃ compara contra historial"
    },
    {
      "parameters": {
        "jsCode": "const posts = $input.all();\n\nif (posts.length === 0) {\n  throw new Error('No hay posts nuevos para publicar');\n}\n\nconst mainPost = posts[0]?.json;\nif (!mainPost) {\n  throw new Error('No se pudo obtener el post principal');\n}\n\nconst additionalPosts = posts.slice(1, 3).map(p => ({\n  title: p.json.title,\n  source: p.json.source\n}));\n\nconst companyConfig = {\n  name: \"Green Hub Portal\",\n  tone: \"profesional, innovador, sostenible\",\n  hashtags: [\"#GreenTech\", \"#InnovaciÃ³n\", \"#Sostenibilidad\", \"#TechNews\"],\n  emoji: [\"ğŸŒ±\", \"ğŸš€\", \"ğŸ’¡\", \"ğŸŒ\", \"âš¡\"]\n};\n\nreturn [{\n  json: {\n    mainPost,\n    additionalPosts,\n    companyConfig,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "d4dc599c-6490-4097-adee-bd6a6e40c7db",
      "name": "ğŸ“¦ Preparar Datos",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [192, 0]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list"
        },
        "messages": {
          "values": [
            {
              "content": "=Genera un hook LinkedIn de MÃXIMO 20 palabras.\n\nPost: {{ $json.mainPost.title }}\nTono: {{ $json.companyConfig.tone }}\n\nRESPONDE SOLO EL HOOK. Sin comillas."
            }
          ]
        },
        "options": {
          "maxTokens": 40,
          "temperature": 0.8
        }
      },
      "id": "5e20a6fd-58e7-45fc-8aeb-099d5609e701",
      "name": "ğŸ¤– Generar Hook",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.5,
      "position": [368, 0],
      "credentials": {
        "openAiApi": {
          "id": "UnprA8703Is7HbnG",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const hook = $input.first().json.message.content.replace(/[\"']/g, '').trim();\nconst data = $('Preparar Datos').first().json;\nconst { mainPost, companyConfig } = data;\n\nconst emoji = companyConfig.emoji[Math.floor(Math.random() * companyConfig.emoji.length)];\n\nconst linkedInPost = `${emoji} ${hook}\n\n${mainPost.title}\n\n${mainPost.description}...\n\nğŸ’¡ Fuente: ${mainPost.source}\nğŸ”— ${mainPost.url}\n\n${companyConfig.hashtags.join(' ')}`;\n\nconst metadata = {\n  postId: mainPost.url,\n  url: mainPost.url,\n  timestamp: new Date().toISOString(),\n  relevanceScore: mainPost.relevanceScore,\n  source: mainPost.source,\n  tokensUsed: 40,\n  estado: 'publicado'\n};\n\nreturn [{\n  json: {\n    text: linkedInPost,\n    metadata\n  }\n}];"
      },
      "id": "48549357-d005-41f4-850d-416e220dbbd0",
      "name": "ğŸ—ï¸ Construir Post",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [544, 0]
    },
    {
      "parameters": {
        "person": {
          "__rl": true,
          "value": "urn:li:person:REEMPLAZAR_CON_TU_PERSON_URN",
          "mode": "id"
        },
        "text": "={{ $json.text }}",
        "additionalFields": {}
      },
      "id": "fc8dad3c-4092-4b04-aebb-2ff99c18fd9e",
      "name": "ğŸ“¤ Publicar LinkedIn",
      "type": "n8n-nodes-base.linkedIn",
      "typeVersion": 1,
      "position": [720, 0],
      "credentials": {
        "linkedInOAuth2Api": {
          "id": "iiEjaKHlMEC73APq",
          "name": "LinkedIn account"
        }
      },
      "notes": "âš ï¸ CAMBIAR: Reemplaza REEMPLAZAR_CON_TU_PERSON_URN con tu URN"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/19jRpln8DJaHtalKrKwUZoktJk0mAxrM-ye6dgRhV7dI/edit?gid=0#gid=0",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "value": "Historial",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "url": "={{ $json.metadata.url }}",
            "postId": "={{ $json.metadata.postId }}",
            "timestamp": "={{ $json.metadata.timestamp }}",
            "source": "={{ $json.metadata.source }}",
            "estado": "={{ $json.metadata.estado }}",
            "tokensUsed": "={{ $json.metadata.tokensUsed }}"
          }
        },
        "options": {}
      },
      "id": "c7443cc1-8d21-408e-8d2a-12b161e2967a",
      "name": "âœ… Guardar Historial",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [896, 0],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Uju33mfMH1AoSojL",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// âœ… CORREGIDO: Referencias correctas a nodos\nconst combinedFeeds = $('Combinar Feeds').all();\nconst filtered = $('Filtrar y Puntuar').all();\nconst published = $('Construir Post').first().json.metadata;\n\nconst metrics = {\n  workflow: \"LinkedIn Auto-Publisher Green Hub\",\n  execution: {\n    timestamp: new Date().toISOString(),\n    success: true\n  },\n  tokens: {\n    used: 40,\n    traditional_method: 5000,\n    saved: 4960,\n    savings_percentage: \"99.2%\"\n  },\n  posts: {\n    processed: combinedFeeds.length,\n    filtered: filtered.length,\n    published: 1\n  },\n  cost: {\n    actual: \"$0.001\",\n    traditional: \"$0.10\",\n    saved: \"$0.099\"\n  }\n};\n\nconsole.log(\"=== WORKFLOW METRICS ===\");\nconsole.log(JSON.stringify(metrics, null, 2));\n\nreturn [{ json: metrics }];"
      },
      "id": "00bf4b65-42bf-4dfb-b3bd-be60309c9757",
      "name": "ğŸ“ˆ MÃ©tricas (CORREGIDO)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1072, 0],
      "notes": "âœ… CORREGIDO: Referencias a nodos correctas"
    }
  ],
  "connections": {
    "â° Ejecutar cada 3 horas": {
      "main": [
        [
          {
            "node": "ğŸ“° RSS TechCrunch",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“° RSS Hacker News",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“° LinkedIn API (CORREGIDO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“° RSS TechCrunch": {
      "main": [
        [
          {
            "node": "ğŸ”„ Combinar Feeds",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“° RSS Hacker News": {
      "main": [
        [
          {
            "node": "ğŸ”„ Combinar Feeds",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ğŸ“° LinkedIn API (CORREGIDO)": {
      "main": [
        [
          {
            "node": "ğŸ”„ Transformar LinkedIn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ Transformar LinkedIn": {
      "main": [
        [
          {
            "node": "ğŸ”„ Combinar Feeds",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "ğŸ”„ Combinar Feeds": {
      "main": [
        [
          {
            "node": "ğŸ”§ Filtrar y Puntuar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ Filtrar y Puntuar": {
      "main": [
        [
          {
            "node": "ğŸ“Š Leer Historial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Leer Historial": {
      "main": [
        [
          {
            "node": "ğŸ” Verificar Duplicados (CORREGIDO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Verificar Duplicados (CORREGIDO)": {
      "main": [
        [
          {
            "node": "ğŸ“¦ Preparar Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ Preparar Datos": {
      "main": [
        [
          {
            "node": "ğŸ¤– Generar Hook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤– Generar Hook": {
      "main": [
        [
          {
            "node": "ğŸ—ï¸ Construir Post",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—ï¸ Construir Post": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Publicar LinkedIn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¤ Publicar LinkedIn": {
      "main": [
        [
          {
            "node": "âœ… Guardar Historial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… Guardar Historial": {
      "main": [
        [
          {
            "node": "ğŸ“ˆ MÃ©tricas (CORREGIDO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
