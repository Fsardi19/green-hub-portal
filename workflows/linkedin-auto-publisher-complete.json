{
  "name": "Green Hub Portal - LinkedIn Auto-Publisher (Completo)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 3
            }
          ]
        }
      },
      "id": "b55fd2fd-fc21-41d9-82c0-d2df9bf267b4",
      "name": "â° Ejecutar cada 3 horas",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [-1024, 32],
      "notes": "Ajusta la frecuencia segÃºn tu necesidad de publicaciÃ³n"
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "requestMethod": "GET",
        "url": "https://api.linkedin.com/v2/organizationalEntityShareStatistics?q=organizationalEntity&organizationalEntity=urn:li:organization:92768394&count=10",
        "options": {}
      },
      "id": "af67b39d-ed29-4429-a5a7-3b92805db963",
      "name": "ğŸ“° Obtener Posts LinkedIn API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [-816, 32],
      "credentials": {
        "oAuth2Api": {
          "id": "YOUR_LINKEDIN_OAUTH_CREDENTIAL_ID",
          "name": "LinkedIn OAuth2"
        }
      },
      "notes": "Reemplaza 92768394 con tu Organization ID"
    },
    {
      "parameters": {
        "jsCode": "// ğŸš€ OPTIMIZACIÃ“N: Procesamiento sin tokens\n// Filtra, deduplica y calcula relevancia\n\nconst response = $input.first().json;\nconst items = response.elements || [];\nconst processedItems = [];\nconst seenIds = new Set();\n\n// Obtener timestamp de la Ãºltima ejecuciÃ³n (3 horas atrÃ¡s)\nconst lastRun = new Date(Date.now() - 3 * 60 * 60 * 1000);\n\nitems.forEach(item => {\n  // Verificar si es contenido nuevo\n  const pubDate = new Date(item.created?.time || Date.now());\n  if (pubDate < lastRun) return;\n  \n  // DeduplicaciÃ³n por ID\n  const itemId = item.organizationalEntity || item.id;\n  if (seenIds.has(itemId)) return;\n  seenIds.add(itemId);\n  \n  // Calcular score de relevancia (0 tokens usado)\n  let relevanceScore = 0;\n  \n  // Keywords importantes para tu empresa\n  const keywords = [\n    'innovaciÃ³n', 'tecnologÃ­a', 'producto', 'lanzamiento',\n    'cliente', 'Ã©xito', 'partnership', 'crecimiento'\n  ];\n  \n  const commentary = item.commentary || item.specificContent?.shareCommentary?.text || '';\n  const contentToCheck = commentary.toLowerCase();\n  \n  keywords.forEach(keyword => {\n    if (contentToCheck.includes(keyword)) relevanceScore += 10;\n  });\n  \n  // Boost por contenido reciente\n  const hoursOld = (Date.now() - pubDate) / (1000 * 60 * 60);\n  if (hoursOld < 1) relevanceScore += 20;\n  else if (hoursOld < 6) relevanceScore += 10;\n  \n  // Extraer informaciÃ³n limpia\n  const cleanDescription = commentary\n    ?.replace(/<[^>]*>/g, '') // Remover HTML\n    ?.substring(0, 200) // Limitar longitud\n    ?.trim();\n  \n  processedItems.push({\n    id: itemId,\n    title: `LinkedIn Update - ${new Date(pubDate).toLocaleDateString()}`,\n    description: cleanDescription,\n    pubDate: pubDate.toISOString(),\n    relevanceScore,\n    link: `https://www.linkedin.com/feed/update/${itemId}`,\n    stats: {\n      likes: item.totalShareStatistics?.likeCount || 0,\n      comments: item.totalShareStatistics?.commentCount || 0,\n      shares: item.totalShareStatistics?.shareCount || 0\n    },\n    category: 'LinkedIn'\n  });\n});\n\n// Ordenar por relevancia y tomar top 5\nprocessedItems.sort((a, b) => b.relevanceScore - a.relevanceScore);\nconst topPosts = processedItems.slice(0, 5);\n\n// Logging para debug\nconsole.log(`Procesados: ${items.length} posts`);\nconsole.log(`Filtrados: ${topPosts.length} posts relevantes`);\n\nreturn topPosts.map(post => ({ json: post }));"
      },
      "id": "29e91ec3-1851-465c-bf36-20c844a4361c",
      "name": "ğŸ”§ Filtrar y Deduplicar (0 tokens)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-624, 32]
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "YOUR_SHEET_ID",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Historial",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.id }}",
            "titulo": "={{ $json.title }}",
            "fecha_captura": "={{ $json.pubDate }}",
            "estado": "pendiente",
            "relevancia": "={{ $json.relevanceScore }}"
          },
          "matchingColumns": ["id"],
          "schema": []
        },
        "options": {
          "cellFormat": "USER_ENTERED"
        }
      },
      "id": "b0e5eac8-fd13-4b93-a434-194634296da6",
      "name": "ğŸ“Š Verificar Historial",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [-416, 32],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YOUR_GOOGLE_SHEETS_CREDENTIAL_ID",
          "name": "Google Sheets account"
        }
      },
      "notes": "Crea una hoja 'Historial' con columnas: id, titulo, fecha_captura, estado, relevancia"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "conditions": [
            {
              "leftValue": "={{ $json.estado }}",
              "rightValue": "pendiente",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "9d8980e4-b3d4-43c0-974a-1e99e211000d",
      "name": "Â¿Contenido Nuevo?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [-224, 32]
    },
    {
      "parameters": {
        "jsCode": "// ğŸ¯ OPTIMIZACIÃ“N: Preparar batch para IA\n// Agrupamos todo para una sola llamada al LLM\n\nconst items = $input.all();\n\n// Tomar mÃ¡ximo 3 posts para el batch\nconst batchPosts = items.slice(0, 3);\n\n// Crear resumen compacto para la IA\nconst batchSummary = {\n  posts: batchPosts.map(item => ({\n    titulo: item.json.title,\n    descripcion: item.json.description?.substring(0, 100) || '',\n    categoria: item.json.category,\n    stats: item.json.stats\n  })),\n  \n  // Contexto de la empresa (personaliza esto)\n  empresa: {\n    nombre: \"Green Hub\",\n    sector: \"Sostenibilidad\",\n    tono: \"profesional pero cercano\",\n    hashtags: [\"#Sostenibilidad\", \"#GreenHub\", \"#InnovaciÃ³n\"]\n  },\n  \n  // Instrucciones optimizadas para mÃ­nimo uso de tokens\n  instrucciones: \"Genera SOLO un hook de 15 palabras MAX que capture la esencia de estos posts. No explicaciones adicionales.\"\n};\n\n// Preparar para template\nconst postData = {\n  batchSummary,\n  mainPost: batchPosts[0].json, // Post principal\n  additionalPosts: batchPosts.slice(1).map(p => p.json), // Posts adicionales\n  timestamp: new Date().toISOString()\n};\n\nreturn [{ json: postData }];"
      },
      "id": "b7e98c10-0458-4804-bb20-8f5cfc5a19bd",
      "name": "ğŸ“¦ Preparar Batch (0 tokens)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-16, -16]
    },
    {
      "parameters": {
        "model": "gpt-4o-mini",
        "messages": {
          "values": [
            {
              "content": "=Eres un experto en LinkedIn. Genera SOLO un hook atractivo de mÃ¡ximo 15 palabras basado en estos posts:\n\n{{ JSON.stringify($json.batchSummary.posts) }}\n\nEmpresa: {{ $json.batchSummary.empresa.nombre }}\nTono: {{ $json.batchSummary.empresa.tono }}\n\nRESPONDE SOLO CON EL HOOK, NADA MÃS."
            }
          ]
        },
        "options": {
          "maxTokens": 50,
          "temperature": 0.7
        }
      },
      "id": "e3c44c56-51a4-4292-8596-ffd9474212b0",
      "name": "ğŸ¤– Generar Hook (50 tokens)",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [144, -16],
      "credentials": {
        "openAiApi": {
          "id": "YOUR_OPENAI_CREDENTIAL_ID",
          "name": "OpenAi account"
        }
      },
      "notes": "OPTIMIZACIÃ“N: Solo generamos el hook, no todo el post"
    },
    {
      "parameters": {
        "jsCode": "// ğŸš€ OPTIMIZACIÃ“N FINAL: Construir post con template\n// Usa IA solo para el hook, resto es template\n\nconst aiResponse = $input.first().json;\nconst aiHook = aiResponse.response || aiResponse.text || aiResponse.message?.content || 'Novedades importantes';\nconst postData = $node[\"Preparar Batch (0 tokens)\"].json;\nconst mainPost = postData.mainPost;\n\n// Template optimizado para LinkedIn\nconst linkedInPost = {\n  content: `${aiHook}\n\nğŸ“° ${mainPost.title}\n\n${mainPost.description?.substring(0, 150)}...\n\nğŸ”— Leer mÃ¡s: ${mainPost.link}\n\n${postData.batchSummary.empresa.hashtags.join(' ')} #${postData.batchSummary.empresa.nombre}`,\n  \n  metadata: {\n    originalUrl: mainPost.link,\n    publishTime: new Date().toISOString(),\n    tokensUsed: 50, // Solo el hook usÃ³ tokens\n    processedPosts: postData.batchSummary.posts.length\n  }\n};\n\n// Preparar para LinkedIn API\nconst linkedInPayload = {\n  text: linkedInPost.content,\n  visibility: 'PUBLIC'\n};\n\nreturn [{\n  json: {\n    linkedInPayload,\n    postMetadata: linkedInPost.metadata,\n    trackingData: {\n      postId: mainPost.id,\n      timestamp: new Date().toISOString()\n    }\n  }\n}];"
      },
      "id": "d6506897-6331-46dd-b274-46422ba26eca",
      "name": "ğŸ—ï¸ Construir Post (0 tokens)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [416, -16]
    },
    {
      "parameters": {
        "person": {
          "__rl": true,
          "value": "YOUR_LINKEDIN_PERSON_URN",
          "mode": "id"
        },
        "text": "={{ $json.linkedInPayload.text }}",
        "additionalFields": {}
      },
      "id": "4d3f2ff3-b4dd-431d-9ea9-a92d6bd5a17c",
      "name": "ğŸ“¤ Publicar en LinkedIn",
      "type": "n8n-nodes-base.linkedIn",
      "typeVersion": 1,
      "position": [592, -16],
      "credentials": {
        "linkedInOAuth2Api": {
          "id": "YOUR_LINKEDIN_OAUTH_CREDENTIAL_ID",
          "name": "LinkedIn account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "YOUR_SHEET_ID",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Historial",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.trackingData.postId }}",
            "estado": "publicado",
            "fecha_publicacion": "={{ $json.trackingData.timestamp }}",
            "tokens_usados": "={{ $json.postMetadata.tokensUsed }}"
          },
          "matchingColumns": ["id"]
        },
        "options": {}
      },
      "id": "addec027-55c4-48ed-a9ca-ddc01a9a04f1",
      "name": "âœ… Actualizar Historial",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [784, -16],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YOUR_GOOGLE_SHEETS_CREDENTIAL_ID",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ğŸ“Š MÃ‰TRICAS Y LOGGING\n// Registrar performance y ahorros\n\nconst metrics = {\n  workflow: \"LinkedIn Auto-Publisher Green Hub\",\n  execution: {\n    timestamp: new Date().toISOString(),\n    success: true\n  },\n  tokens: {\n    used: 50,\n    traditional_method: 5000,\n    saved: 4950,\n    savings_percentage: \"99%\"\n  },\n  posts: {\n    processed: $node[\"Obtener Posts LinkedIn API\"].json?.elements?.length || 0,\n    filtered: $node[\"Filtrar y Deduplicar (0 tokens)\"].json?.length || 0,\n    published: 1\n  },\n  cost: {\n    actual: \"$0.001\",\n    traditional: \"$0.10\",\n    saved: \"$0.099\"\n  }\n};\n\nconsole.log(\"=== WORKFLOW METRICS ===\");\nconsole.log(JSON.stringify(metrics, null, 2));\n\nreturn [{json: metrics}];"
      },
      "id": "00bf4b65-42bf-4dfb-b3bd-be60309c9757",
      "name": "ğŸ“ˆ MÃ©tricas",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1008, -16]
    }
  ],
  "pinData": {},
  "connections": {
    "â° Ejecutar cada 3 horas": {
      "main": [[{"node": "ğŸ“° Obtener Posts LinkedIn API", "type": "main", "index": 0}]]
    },
    "ğŸ“° Obtener Posts LinkedIn API": {
      "main": [[{"node": "ğŸ”§ Filtrar y Deduplicar (0 tokens)", "type": "main", "index": 0}]]
    },
    "ğŸ”§ Filtrar y Deduplicar (0 tokens)": {
      "main": [[{"node": "ğŸ“Š Verificar Historial", "type": "main", "index": 0}]]
    },
    "ğŸ“Š Verificar Historial": {
      "main": [[{"node": "Â¿Contenido Nuevo?", "type": "main", "index": 0}]]
    },
    "Â¿Contenido Nuevo?": {
      "main": [[{"node": "ğŸ“¦ Preparar Batch (0 tokens)", "type": "main", "index": 0}]]
    },
    "ğŸ“¦ Preparar Batch (0 tokens)": {
      "main": [[{"node": "ğŸ¤– Generar Hook (50 tokens)", "type": "main", "index": 0}]]
    },
    "ğŸ¤– Generar Hook (50 tokens)": {
      "main": [[{"node": "ğŸ—ï¸ Construir Post (0 tokens)", "type": "main", "index": 0}]]
    },
    "ğŸ—ï¸ Construir Post (0 tokens)": {
      "main": [[{"node": "ğŸ“¤ Publicar en LinkedIn", "type": "main", "index": 0}]]
    },
    "ğŸ“¤ Publicar en LinkedIn": {
      "main": [[{"node": "âœ… Actualizar Historial", "type": "main", "index": 0}]]
    },
    "âœ… Actualizar Historial": {
      "main": [[{"node": "ğŸ“ˆ MÃ©tricas", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "instanceId": "green-hub-portal"
  },
  "tags": []
}
